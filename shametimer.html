<!DOCTYPE HTML>
<html>
 	<head>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Play' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="styles.css" type="text/css">
		<script>
    
    
      function getDevBuilds(){
        var newRequest = new XMLHttpRequest();
        newRequest.open("GET", 'http://teamcity:8080/httpAuth/app/rest/projects/Dev', false); //false = synchronous request
        newRequest.setRequestHeader('Accept', 'application/json');
        newRequest.send();
        response = JSON.parse(newRequest.response);
        return response;
      }

      function populateBuildNames(){
        devBuildNames = [];
        currentDevInfo = getDevBuilds();
        console.log(currentDevInfo);
        currentDevInfo.buildTypes.buildType.forEach(function(build){
          devBuildNames.push(build.id);
        });
        return devBuildNames;
      }

      function timerCtrl($scope, $http, $interval){
        $scope.buildStatus = "running";
        $http({method: 'GET', url: 'http://teamcity:8080/httpAuth/app/rest/builds/project:Dev,status:FAILURE', headers: {'Accept':'application/json'} }).success(function(data){
            var year = data.finishDate.slice(0, 4);
            var month = data.finishDate.slice(4, 6);
            var day = data.finishDate.slice(6, 8);
            var hour = data.finishDate.slice(9, 11);
            var min = data.finishDate.slice(11, 13);
            var sec = data.finishDate.slice(13, 15);
            var mostRecentBuildTimeStamp = new Date(year + "-" + month + "-" + day + "T" + hour + ":" + min + ":" + sec);
            var currentTimeStamp = Date.now();
            $scope.rawTimeElapsed = Math.abs((mostRecentBuildTimeStamp - currentTimeStamp));
            $scope.buildStatus = "broken";
        });

        if ($scope.buildStatus === "running") {

          $http({method: 'GET', url: 'http://teamcity:8080/httpAuth/app/rest/builds/project:Dev,status:SUCCESS', headers: {'Accept':'application/json'} }).success(function(data){
              var year = data.finishDate.slice(0, 4);
              var month = data.finishDate.slice(4, 6);
              var day = data.finishDate.slice(6, 8);
              var hour = data.finishDate.slice(9, 11);
              var min = data.finishDate.slice(11, 13);
              var sec = data.finishDate.slice(13, 15);
              var mostRecentBuildTimeStamp = new Date(year + "-" + month + "-" + day + "T" + hour + ":" + min + ":" + sec);
              var currentTimeStamp = Date.now();
              $scope.rawTimeElapsed = Math.abs((mostRecentBuildTimeStamp - currentTimeStamp));
          });    //end $http.success
        };       //end if

        $interval(function() {
          $scope.formattableTime = moment.duration($scope.rawTimeElapsed);
          $scope.rawTimeElapsed = $scope.rawTimeElapsed + 1000;
        }, 1000);
      }; //end timerCtrl
      
      populateBuildNames();
    </script>

    </head>
    <body ng-app>
        <div ng-controller="timerCtrl" id="main-display">
          <div>Dev Build has been <span id="buildStatus" ng-class="{'broken': 'broken-color', 'running': 'running-color'}[buildStatus]" class="statusColor">{{buildStatus}}</span> for </div>
          <div>{{formattableTime.hours()}} : {{formattableTime.minutes()}} : {{formattableTime.seconds()}}</div>
        </div>
    </body>
</html>