<!DOCTYPE HTML>
<html>
 	<head>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Play' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="styles.css" type="text/css">
		<script>
    
      var currentPassingDevBuilds = [];
      var currentFailingDevBuilds = [];

      function getDevBuildNames(){
        var devBuildNames = [];
        var newRequest = new XMLHttpRequest();

        newRequest.open("GET", 'http://teamcity:8080/httpAuth/app/rest/projects/Dev', false); //false = synchronous request
        newRequest.setRequestHeader('Accept', 'application/json');
        newRequest.send();
        var currentDevInfo = JSON.parse(newRequest.response);
        
        currentDevInfo.buildTypes.buildType.forEach(function(build){
          devBuildNames.push(build.id);
        });
        return devBuildNames;
      }

      function seperateBuildObjects(){
        var baseUrl = 'http://teamcity:8080/httpAuth/app/rest/builds/buildType:'
        var newRequest = new XMLHttpRequest;
        var devBuildNames = getDevBuildNames();

        devBuildNames.forEach(function(buildName){
          newRequest.open("GET", baseUrl + buildName, false);
          newRequest.setRequestHeader('Accept', 'application/json');
          newRequest.send();
          var currentBuild = JSON.parse(newRequest.response);
          
          if (currentBuild.status === "SUCCESS") {
            currentPassingDevBuilds.push(currentBuild);
          } else {
            currentFailingDevBuilds.push(currentBuild);
          }
        });
      };

      function sortSetOfBuilds(buildArray){
        buildArray.sort(function(a,b){
          var aTimeStamp = createTimeStamp(a);
          var bTimeStamp = createTimeStamp(b);
          return aTimeStamp - bTimeStamp;
        });
        return buildArray;
      };

      function createTimeStamp(teamCityTime){
        var year = teamCityTime.finishDate.slice(0, 4);
        var month = teamCityTime.finishDate.slice(4, 6);
        var day = teamCityTime.finishDate.slice(6, 8);
        var hour = teamCityTime.finishDate.slice(9, 11);
        var min = teamCityTime.finishDate.slice(11, 13);
        var sec = teamCityTime.finishDate.slice(13, 15);
        return new Date(year + "-" + month + "-" + day + "T" + hour + ":" + min + ":" + sec);
      }

      //Begin function calls to find get current builds and sort them into passing/failing

      getDevBuildNames();
      seperateBuildObjects();
      if ( currentPassingDevBuilds != [] ) { var mostRecentPassingBuild = sortSetOfBuilds(currentPassingDevBuilds).reverse()[0]; }
      if ( currentFailingDevBuilds != [] ) { var mostRecentFailingBuild = sortSetOfBuilds(currentFailingDevBuilds).reverse()[0]; }

      //End function calls

      //Begin angular controller

      function timerCtrl($scope, $interval){
        if (currentFailingDevBuilds.length === 0) {
          $scope.buildStatus = "running";
          var currentTimeStamp = Date.now();
          var mostRecentPassingBuildTimeStamp = createTimeStamp(mostRecentPassingBuild);
          $scope.rawTimeElapsed = Math.abs(mostRecentPassingBuildTimeStamp - currentTimeStamp);
        } else {
          $scope.buildStatus = "broken";
          var currentTimeStamp = Date.now();
          var mostRecentFailingBuildTimeStamp = createTimeStamp(mostRecentFailingBuild);
          $scope.rawTimeElapsed = Math.abs(mostRecentFailingBuildTimeStamp - currentTimeStamp);
        }
          $interval(function() {
            $scope.formattableTime = moment.duration($scope.rawTimeElapsed);
            $scope.rawTimeElapsed = $scope.rawTimeElapsed + 1000;
          }, 1000);
      };

      //End controller
      
    </script>

    </head>
    <body ng-app>
        <div ng-controller="timerCtrl" id="main-display">
          <div>Dev Build has been <span id="buildStatus" ng-class="{'broken': 'broken-color', 'running': 'running-color'}[buildStatus]" class="statusColor">{{buildStatus}}</span></div>
          <div>for at least</div>
          <div>{{formattableTime.hours()}} : {{formattableTime.minutes()}} : {{formattableTime.seconds()}}</div>
        </div>
    </body>
</html>
